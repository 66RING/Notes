---
title: Buddy系统的原理及实现
date: 2021-01-19
tags: 
- linux
- kernel
- mm
mathjax: true
---

# Buddy系统的原理及实现

在介绍buddy系统前先做个铺垫：空闲链表和内存池。

- 大heap待分配 + bitmap表示分配情况
- 多组空闲列表管理buddy分割后的内存, 方便快速查找

- Q: 释放后在freelist上的组织情况
    * 即怎么高效实现合并: 需要删除链表上旧的项 -> ⭐ 可以物理地址头部就是节点的内存布局!!

https://zhuanlan.zhihu.com/p/73562347


## 空闲列表

内存中的空闲内存块以列表的形式组织起来，称为free list。需要内存分配时扫描列表的空闲内存块，从空闲列表中移除，释放时再放回。这里就会存在不同的内存块选择策略：

- First fir
    * 取最先遇到的大小足够的块
- Best fit
    * 取和申请内存大小最接近的
- Worst fit
    * 取和申请内存大小最不接近的


## 内存池

空闲列表效率不高且容易产生大量内存碎片，而内存池则是将大内存分成若干小内存块(如32, 64, 128字节)，同一大小的内存以空闲列表的发生连接：

```
| 32 | -> | 32 | -> | 32 |
  |                    
| 64 | -> | 64 | -> | 64 |
  |                    
| 128| -> | 128| -> | 128|
  |
```

每次分配内存从大小最接近的内存池中选择一个分配。

这样减少空闲列表的长度，提高效率，但是内存块设置过多过少都会造成浪费。对不同系统需要不同的配置，不通用。


## Buddy系统原理

在内存池的基础上，buddy系统(伙伴系统)会将 **相邻的** 内存块合并，形成新的大小的内存块，然后移动到新大小对应的空闲列表上。

申请内存时，如果申请的尺寸或略大的尺寸有空闲，则直接分配;如果空闲的尺寸比申请的尺寸大得多，如申请128空闲512，则会将512分成一块268，和两块128。其中一块128用于分配。如此剩下的一块268和一块128内存块就归到对应大小的空闲列表。

释放内存时，如果没有相邻的空闲内存，则将释放的内存块放入其对应大小的空闲列表。如果有相邻，则把相邻的内存合并成新的大内存，放入对应大小的空闲列表。

物理上，内存块是连续的;逻辑上，内存块是由空闲列表连接的。

当然，每次检查内存是否可以合并也会造成额外开销。


## Buddy系统实现

TODO

https://zhuanlan.zhihu.com/p/105589621










